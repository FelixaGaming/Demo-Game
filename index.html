<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Words have Power</title>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RR6PRVFRVK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-RR6PRVFRVK');
</script>
  <style>
    :root {
      --bg: #ffffff;
      --panel: #ffffff;
      --muted: #555555;
      --text: #1a1a1a;
      --accent: #FFD700; /* Gold */
      --good: #22c55e;
      --bad: #ef4444;
      --bubble: #ffffff;
      --shadow: 0 4px 12px rgba(0,0,0,.1);
      --table: rgba(0,0,0,.04);
    }
    * { box-sizing: border-box; }
    
    html {
      background: #ffffff !important;
      margin: 0 !important;
      padding: 0 !important;
    }
    
    /* Touch-friendly interactions */
    button, .choice-btn, .cta, .reset { 
      -webkit-tap-highlight-color: rgba(255,215,0,.2);
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
    }
    
    body {
      margin: 0; padding: 12px; background: #ffffff !important;
      color: var(--text); font: 16px/1.45 -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
      min-height: 100vh; display: flex; align-items: center; justify-content: center;
    }
    .app { width: min(1080px, 100%); max-width: 100%; background: transparent !important; }
    header { display: none !important; }
    .title { display: grid; gap: 4px; }
    h1 { font-size: 20px; margin: 0; line-height: 1.2; }
    .subtitle { color: #555; font-size: 13px; line-height: 1.4; }
    .card { background: transparent !important; border: none !important; box-shadow: none !important; }
    .post { background: transparent !important; border: none !important; box-shadow: none !important; padding: 0 !important; margin: 0 !important; }
    .post-header { display: none !important; }
    .video-title { display: none !important; }
    .post-stats { display: none !important; }
    .chips { display: none !important; }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background-color: #ffffff;
      padding: 32px;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .modal-header {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 20px;
      color: #1a1a1a;
    }
    
    .modal-body {
      font-size: 15px;
      line-height: 1.6;
      color: #333;
      margin-bottom: 20px;
    }
    
    .modal-body p {
      margin: 12px 0;
    }
    
    .modal-footer {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 24px;
    }
    
    .modal-close {
      background: #FFD700;
      color: #333;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    .modal-close:hover {
      background: #FFC700;
      transform: scale(1.05);
    }
    .post-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #FFD700, #FFC700); display: grid; place-items: center; font-size: 20px; border: 2px solid rgba(255,215,0,0.3); }
    .post-meta { display: flex; flex-direction: column; gap: 3px; }
    .post-channel { font-weight: 600; font-size: 15px; }
    .post-time { font-size: 12px; color: #666; }
    .video-thumbnail { 
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      background: transparent !important;
      border: none !important;
      margin: 0 !important;
      padding: 0 !important;
      min-height: 100px;
      position: relative;
    }
    .video-thumbnail:hover { transform: scale(1.02); }
    .video-playing {
      cursor: pointer;
    }
    .video-playing:hover {
      border-color: rgba(139,92,246,0.3);
    }
    .video-thumbnail::before {
      display: none !important;
    }
    .video-playing::after {
      content: '';
      position: absolute;
      inset: 0;
      background-image: 
        repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,.03) 2px, rgba(255,255,255,.03) 4px);
      opacity: 0.1;
      animation: filmGrain 0.2s steps(2) infinite;
      pointer-events: none;
      z-index: 4;
    }
    @keyframes filmGrain {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(2px); }
    }
    .video-content {
      display: none !important;
    }
    .video-scene {
      display: none !important;
    }
    .video-caption {
      display: none !important;
    }
    .video-duration {
      display: none !important;
    }
    .play-button {
      display: none !important;
    }
    .play-button {
      width: 68px;
      height: 68px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 28px;
      color: #000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      transition: all 0.2s ease;
    }
    .video-thumbnail:hover .play-button {
      background: rgba(139,92,246,0.95);
      color: white;
      transform: scale(1.1);
    }
    .video-playing {
      background: linear-gradient(135deg, #0f0f12, #1a1a1a) !important;
    }
    .video-playing::before { opacity: 0.3 !important; }
    .video-caption {
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.9);
      padding: 16px 18px;
      border-radius: 10px;
      font-size: 15px;
      line-height: 1.5;
      text-align: left;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s ease;
      z-index: 10;
      backdrop-filter: blur(8px);
      border-left: 4px solid #ef4444;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    .video-caption.active {
      opacity: 1;
      transform: translateY(0);
    }
    .video-caption.caption-concern {
      background: rgba(239, 68, 68, 0.25);
      border-left: 4px solid #ef4444;
      backdrop-filter: blur(12px);
    }
    .video-caption.caption-counter {
      background: rgba(34, 197, 94, 0.25);
      border-left: 4px solid #22c55e;
      backdrop-filter: blur(12px);
    }
    .video-playing .video-content { opacity: 0; pointer-events: none; }
    .video-scene {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2;
    }
    .video-playing .video-scene { display: flex; }
    
    /* Full-screen video scene */
    .scene-discussion {
      position: relative;
      width: 100%;
      height: 100%;
    }
    
    .pause-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 68px;
      height: 68px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 50%;
      display: none !important;
      place-items: center;
      font-size: 28px;
      color: #000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      cursor: pointer;
      z-index: 5;
      transition: all 0.2s ease;
    }
    .pause-button:hover {
      background: rgba(139,92,246,0.95);
      color: white;
      transform: translate(-50%, -50%) scale(1.1);
    }
    .video-playing .pause-button { display: none !important; }
    .video-duration {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.85);
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 700;
      z-index: 11;
      backdrop-filter: blur(4px);
    }
    .video-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255,0,0,0.95);
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      z-index: 11;
      box-shadow: 0 2px 8px rgba(255,0,0,0.4);
    }
    .video-player { width: 100%; border-radius: 12px; overflow: hidden; margin-bottom: 8px; background: #000; aspect-ratio: 16/9; }
    .video-player video { width: 100%; height: 100%; display: block; }
    .video-title { font-weight: 600; font-size: 15px; line-height: 1.4; margin-bottom: 8px; }
    .post-stats { display: flex; gap: 16px; font-size: 13px; color: var(--muted); margin-bottom: 8px; }
    .stat-item { display: flex; align-items: center; gap: 4px; }
    .chips { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip { font-size: 12px; color: #3ea6ff; background: transparent; padding: 0; border: none; font-weight: 500; cursor: pointer; }
    .chip:hover { text-decoration: underline; }

    .stage { 
      display: flex; 
      flex-direction: column; 
      gap: 12px; 
      max-height: 60vh; 
      overflow-y: auto; 
      overflow-x: hidden;
      padding-right: 2px;
      scroll-behavior: smooth;
      background: transparent !important;
      /* Hide scrollbar for cleaner look */
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE and Edge */
    }
    .stage::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }
    .stage.entering {
      animation: stageEnter 0.6s ease forwards;
    }
    @keyframes stageEnter {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .thread { display: grid; gap: 10px; margin-bottom: 16px; }
    .msg { display: grid; grid-template-columns: 36px 1fr; gap: 10px; margin-bottom: 12px; }
    .avatar { width: 36px; height: 36px; border-radius: 50%; display: grid; place-items: center; font-weight: 700; color: white; background: linear-gradient(135deg, #FFD700, #FFC700); border: 2px solid rgba(255,215,0,.4); font-size: 16px; }
    .avatar--sarah { background: linear-gradient(135deg, #FFD700, #FFC700); border: 2px solid #FFD700; }
    .avatar--sarah::before { content: '👩'; }
    .avatar--rex   { background: linear-gradient(135deg, #ef4444, #dc2626); border: 2px solid #ef4444; }
    .avatar--rex::before { content: '🎮'; }
    .avatar--clod24 { background: linear-gradient(135deg, #4B5563, #2D3436); border: 3px solid #FF6B6B; }
    .avatar--clod24::before { content: '⚠️'; }
    .avatar--you   { background: linear-gradient(135deg, #22c55e, #16a34a); border: 2px solid #22c55e; }
    .avatar--you::before { content: '⭐'; }
    .bubble { background: var(--bubble); border: 1px solid rgba(0,0,0,.08); padding: 12px 14px; border-radius: 12px; font-size: 15px; line-height: 1.6; word-wrap: break-word; color: #1a1a1a; }
    .name { font-weight: 700; margin-bottom: 2px; font-size: 13px; }
    .meta { color: var(--muted); font-size: 12px; }

    .choices { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 14px; }
    .choice-btn { width: 100%; text-align: left; border: 2px solid #FFD700; background: #ffffff; color: var(--text); border-radius: 12px; padding: 14px 16px; cursor: pointer; font-size: 15px; line-height: 1.5; min-height: 50px; display: flex; align-items: center; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif; }
    .choice-btn:hover { border-color: #FFA500; background: #fffef5; }
    .choice-btn:active { /* No animation */ }
    .choice-btn.highlight:hover {
      /* No animation */
    }
    .choice-btn:disabled { cursor: not-allowed; }
    .choice-btn.highlight {
      border-color: rgba(255,215,0,.8);
      background: #ffffff;
    }
    .choice-prompt {
      text-align: center;
      color: var(--accent);
      font-size: 14px;
      font-weight: 600;
      margin-top: 12px;
      opacity: 0;
      animation: fadeInPrompt 0.5s ease forwards;
      display: none;
      position: relative;
    }
    .choice-prompt.show { 
      display: block; 
    }
    .choice-prompt::before {
      content: 'ðŸ‘†';
      display: inline-block;
      animation: pointUp 1s ease-in-out infinite;
      margin-right: 8px;
    }
    @keyframes pointUp {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    @keyframes fadeInPrompt {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .video-transition {
      animation: fadeOut 0.5s ease forwards;
    }
    @keyframes fadeOut {
      to { opacity: 0; }
    }

    .feedback { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      background: #f5f5f5;
      border: none;
      border-left: 3px solid #22c55e; 
      padding: 12px 14px; 
      border-radius: 6px; 
      font-size: 13px; 
      line-height: 1.5;
      color: #333;
      font-style: italic;
      margin-top: 12px;
      margin-left: 38px;
      width: calc(100% - 38px);
      transition: opacity 0.4s ease;
    }
    .feedback.negative {
      background: #fafafa;
      border-left: 3px solid #ef4444;
    }
    .feedback .tag { font-weight: 700; color: var(--accent); margin-right: 4px; font-size: 12px; }
    .feedback img { flex-shrink: 0; }

    .controls { display: flex; gap: 10px; justify-content: space-between; align-items: center; margin-top: 8px; }
    .pill { padding: 8px 12px; border-radius: 999px; border: 1px solid rgba(0,0,0,.12); color: var(--muted); font-size: 12px; }
    .cta { background: var(--accent); color: #333333; border: none; border-radius: 999px; padding: 12px 18px; font-weight: 700; cursor: pointer; font-size: 15px; min-height: 48px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif; }
    .cta:hover { /* No animation */ }
    .cta:active { /* No animation */ }
    
    .reset { background: transparent; border: 2px solid #888888; color: var(--text); padding: 12px 18px; border-radius: 999px; cursor: pointer; font-size: 15px; min-height: 48px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif; }
    .reset:active { /* No animation */ }

    .divider { height: 1px; background: rgba(0,0,0,.08); margin: 8px 0; }

    /* Progress */
    .progress-wrap { display: none !important; }
    .progress-bar { display: none !important; }

    .fade-in { 
      animation: slideUp 0.4s ease;
    }
    @keyframes slideUp {
      from { 
        opacity: 0; 
        transform: translateY(10px);
      } 
      to { 
        opacity: 1; 
        transform: translateY(0);
      } 
    }

    /* Typing Indicator */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 12px 14px;
      margin-bottom: 8px;
    }
    .typing-indicator .dot {
      width: 8px;
      height: 8px;
      background: #888;
      border-radius: 50%;
      animation: typingDot 1.4s infinite;
    }
    .typing-indicator .dot:nth-child(2) {
      animation-delay: 0.2s;
    }
    .typing-indicator .dot:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes typingDot {
      0%, 60%, 100% {
        opacity: 0.3;
        transform: scale(0.8);
      }
      30% {
        opacity: 1;
        transform: scale(1.1);
      }
    }

    /* End/Results */
    .center { text-align: center; }
    .end-title { font-size: 20px; font-weight: 800; margin-bottom: 6px; }
    .end-sub { color: var(--muted); margin-bottom: 16px; font-size: 14px; }

    /* Animated Score Display */
    .score-reveal {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
      gap: 32px;
    }
    .score-number {
      font-size: 120px;
      font-weight: 800;
      color: var(--accent);
      line-height: 1;
      opacity: 0;
      transform: scale(0.5);
      animation: scoreAppear 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }
    @keyframes scoreAppear {
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    .score-label {
      font-size: 24px;
      font-weight: 600;
      color: var(--text);
      opacity: 0;
      animation: fadeInUp 0.6s ease 0.4s forwards;
    }
    .score-sublabel {
      font-size: 16px;
      color: var(--muted);
      opacity: 0;
      animation: fadeInUp 0.6s ease 0.6s forwards;
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .next-btn {
      opacity: 0;
      animation: fadeInUp 0.6s ease 1s forwards;
    }

    /* Tables */
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    thead th { text-align: left; font-size: 13px; color: #1a1a1a; border-bottom: 1px solid var(--table); padding: 10px; font-weight: 600; }
    tbody td { border-bottom: 1px solid var(--table); padding: 10px; vertical-align: top; font-size: 14px; line-height: 1.5; word-wrap: break-word; max-width: 400px; color: #1a1a1a; }
    .tcard { background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.98)); border: 1px solid rgba(0,0,0,.08); border-radius: 14px; padding: 14px; box-shadow: var(--shadow); }
    .tcard .name { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
    .k { color: var(--muted); font-size: 12px; }

    /* Matrix profile styles */
    .matrix-container { display: grid; gap: 16px; margin-top: 12px; }
    .profile-matrix { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 16px; }
    .profile-cell { padding: 12px 8px; border-radius: 0; cursor: pointer; transition: opacity .2s ease; border: none; background: transparent; position: relative; text-align: center; }
    .profile-cell::before { display: none; }
    .profile-cell:hover { transform: none; box-shadow: none; }
    .profile-cell:hover::before { opacity: 0; }
    .cell-name { font-weight: 400; font-size: 13px; margin-bottom: 6px; position: relative; z-index: 1; color: var(--text); }
    .cell-count { font-size: 16px; font-weight: 600; color: var(--text); position: relative; z-index: 1; margin-bottom: 4px; line-height: 1; }
    .cell-level { display: none; }
    .profile-section { }
    .section-title { font-size: 12px; font-weight: 700; color: var(--accent); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; }
    .tooltip { position: fixed; background: rgba(31,33,39,.95); border: 1px solid rgba(139,92,246,.7); border-radius: 10px; padding: 14px; font-size: 13px; color: var(--text); z-index: 100; max-width: 200px; box-shadow: 0 12px 32px rgba(139,92,246,.2); backdrop-filter: blur(4px); }
    .tooltip-label { font-weight: 700; color: var(--accent); margin-bottom: 6px; font-size: 14px; }
    .tooltip-def { color: var(--muted); font-size: 12px; line-height: 1.5; }

    /* Behavioral Analysis Styles */
    .analysis-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(139,92,246,.2);
    }
    .growth-meter {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(34,197,94,.15), rgba(34,197,94,.08));
      border-radius: 14px;
      border: 2px solid rgba(34,197,94,.4);
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }
    .growth-meter::before {
      content: '✨';
      position: absolute;
      font-size: 60px;
      opacity: 0.1;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
    }
    .growth-score {
      font-size: 48px;
      font-weight: 800;
      color: var(--good);
      line-height: 1;
      text-shadow: 0 2px 8px rgba(34,197,94,.3);
      animation: scoreAppear 0.8s ease;
    }
    @keyframes scoreAppear {
      from { transform: scale(0); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .growth-label {
      flex: 1;
      font-size: 15px;
      line-height: 1.4;
      position: relative;
      z-index: 1;
    }
    .growth-bar-container {
      width: 100%;
      height: 10px;
      background: rgba(255,255,255,.1);
      border-radius: 10px;
      overflow: hidden;
      margin-top: 8px;
      box-shadow: inset 0 2px 4px rgba(0,0,0,.2);
    }
    .growth-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--good), var(--accent));
      border-radius: 10px;
      transition: width 1.5s cubic-bezier(0.65, 0, 0.35, 1);
      box-shadow: 0 0 10px rgba(34,197,94,.4);
    }
    .strategy-grid {
      display: grid;
      gap: 12px;
      margin-top: 16px;
    }
    .strategy-card {
      background: transparent;
      border: 2px solid #FFD700;
      border-radius: 12px;
      padding: 0;
      transition: all .3s ease;
      cursor: pointer;
      overflow: hidden;
    }
    .strategy-card:hover {
      border-color: #FFC700;
      transform: none;
      box-shadow: none;
    }
    .strategy-card.expanded {
      border-color: #FFD700;
      box-shadow: none;
    }
    .strategy-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      cursor: pointer;
      user-select: none;
    }
    .strategy-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 16px;
      color: #1a1a1a;
    }
    .strategy-icon {
      display: none;
    }
    .strategy-expand {
      font-size: 24px;
      color: var(--accent);
      transition: transform 0.3s ease;
    }
    .strategy-card.expanded .strategy-expand {
      transform: rotate(180deg);
    }
    .strategy-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      padding: 0 16px;
    }
    .strategy-card.expanded .strategy-content {
      max-height: 500px;
      padding: 0 16px 16px 16px;
    }
    .strategy-description {
      font-size: 14px;
      line-height: 1.6;
      color: var(--text);
      margin-bottom: 12px;
    }
    .strategy-technique {
      padding: 12px;
      background: transparent;
      border-left: 3px solid #FFD700;
      border-radius: 0;
      font-size: 13px;
      line-height: 1.6;
    }
    .technique-label {
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 6px;
      display: block;
    }
    .insight-box {
      background: transparent;
      border: none;
      border-radius: 0;
      padding: 0;
      margin-bottom: 16px;
    }
    .insight-title {
      font-weight: 700;
      font-size: 16px;
      color: #1a1a1a;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .insight-text {
      font-size: 14px;
      line-height: 1.6;
    }
    .pattern-badge {
      display: inline-block;
      padding: 6px 12px;
      background: rgba(239,68,68,.15);
      border: 1px solid rgba(239,68,68,.4);
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      color: #ef4444;
      margin-right: 8px;
      margin-bottom: 8px;
      transition: all .2s ease;
    }
    .pattern-badge:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(239,68,68,.3);
    }
    .strength-badge {
      display: inline-block;
      padding: 6px 12px;
      background: rgba(34,197,94,.15);
      border: 1px solid rgba(34,197,94,.4);
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      color: #22c55e;
      margin-right: 8px;
      margin-bottom: 8px;
      transition: all .2s ease;
    }
    .strength-badge:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(34,197,94,.3);
    }
    .fun-tip {
      background: transparent;
      border: 2px solid #FFD700;
      border-radius: 12px;
      padding: 14px;
      margin-top: 16px;
      font-size: 14px;
      line-height: 1.6;
    }
    .fun-tip-title {
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
    }
    .emoji-big {
      font-size: 32px;
      display: inline-block;
      animation: emojiFloat 3s ease-in-out infinite;
    }
    @keyframes emojiFloat {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-8px) rotate(5deg); }
    }

    .play-count-display {
      font-size: 13px;
      color: #666;
      text-align: center;
      margin-top: 20px;
      font-style: italic;
    }

    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-top: 8px;
    }
    .table-wrapper table {
      min-width: 100%;
    }

    /* Mobile optimizations */
    @media (max-width: 640px) {
      body { padding: 10px; font-size: 16px; }
      .app { width: 100%; }
      h1 { font-size: 20px; }
      .subtitle { font-size: 13px; }
      .card { padding: 12px; border-radius: 12px; }
      .post { gap: 12px; margin-bottom: 12px; }
      .stage { max-height: 60vh; gap: 12px; }
      .msg { grid-template-columns: 40px 1fr; gap: 8px; margin-bottom: 12px; }
      .avatar { width: 40px; height: 40px; font-size: 16px; }
      .bubble { padding: 12px 14px; font-size: 15px; border-radius: 12px; line-height: 1.5; }
      .name { font-size: 14px; margin-bottom: 6px; }
      .choices { grid-template-columns: 1fr; gap: 10px; }
      .choice-btn { padding: 14px 16px; font-size: 15px; min-height: 52px; line-height: 1.4; }
      .feedback { padding: 10px 12px; font-size: 13px; border-radius: 8px; line-height: 1.4; }
      .cta, .reset { padding: 12px 18px; font-size: 16px; min-height: 48px; }
      .video-caption { font-size: 14px; padding: 12px 14px; bottom: 15px; left: 10px; right: 10px; line-height: 1.5; }
      .scene-discussion { width: 100%; height: 100%; }
      .post-header { gap: 10px; }
      .post-avatar { width: 40px; height: 40px; font-size: 18px; }
      .post-channel { font-size: 14px; }
      .post-time { font-size: 12px; }
      .video-title { font-size: 15px; }
      .profile-matrix { grid-template-columns: repeat(auto-fit, minmax(85px, 1fr)); gap: 10px; }
      .profile-cell { padding: 12px 8px; }
      .cell-count { font-size: 18px; }
      .cell-name { font-size: 13px; }
      .k { font-size: 13px; line-height: 1.5; }
      table { font-size: 14px; }
      thead th { font-size: 13px; padding: 10px; }
      tbody td { padding: 10px; font-size: 14px; line-height: 1.4; }
      .tcard { padding: 14px; }
      .growth-score { font-size: 40px; }
      .growth-meter { padding: 14px; }
      .strategy-grid { gap: 12px; }
      .strategy-card { border-radius: 10px; }
      .strategy-header { padding: 14px; }
      .strategy-title { font-size: 15px; }
      .strategy-icon { font-size: 20px; }
      .strategy-expand { font-size: 20px; }
      .strategy-card.expanded .strategy-content { padding: 0 14px 14px 14px; }
      .strategy-description { font-size: 14px; line-height: 1.5; }
      .strategy-technique { padding: 12px; font-size: 13px; line-height: 1.5; }
      .insight-box { padding: 14px; }
      .insight-title { font-size: 15px; }
      .insight-text { font-size: 14px; line-height: 1.5; }
      .fun-tip { padding: 14px; font-size: 14px; line-height: 1.5; }
      .emoji-big { font-size: 28px; }
      .footer-logo { height: 32px; }
      .like-icon { font-size: 16px; }
      .likes-count { font-size: 13px; }
      .score-number { font-size: 80px; }
      .score-label { font-size: 20px; }
      .score-sublabel { font-size: 14px; }
    }
    
    @media (min-width: 641px) { 
      .choices { grid-template-columns: 1fr 1fr; } 
    }

    /* Likes Animation - YouTube Style */
    .likes-animation {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: 38px;
      margin-top: 4px;
      padding: 6px 0;
      width: fit-content;
      opacity: 0;
      transform: scale(0.8);
      animation: likesAppear 0.4s ease forwards;
    }
    @keyframes likesAppear {
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    .like-icon {
      font-size: 16px;
      opacity: 0;
      transform: scale(0);
      display: inline-block;
    }
    .like-icon.animate {
      animation: likeIconPop 0.3s ease forwards;
    }
    @keyframes likeIconPop {
      0% {
        opacity: 0;
        transform: scale(0);
      }
      50% {
        transform: scale(1.2);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }
    .likes-count {
      font-size: 13px;
      font-weight: 500;
      color: var(--muted);
      opacity: 0;
      animation: countFadeIn 0.3s ease 0.2s forwards;
    }
    @keyframes countFadeIn {
      to {
        opacity: 1;
      }
    }

    /* Footer styles */
    .footer { border-top: 1px solid rgba(0,0,0,.08); margin-top: 32px; padding-top: 24px; padding-bottom: 16px; display: flex; align-items: center; justify-content: center; gap: 16px; opacity: 0.7; transition: opacity .2s ease; }
    .footer:hover { opacity: 1; }
    .footer-logo { height: 40px; width: auto; }
    .footer-link { color: var(--accent); text-decoration: none; font-weight: 600; font-size: 14px; }
    .footer-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <h1>Words have <span style="color:var(--accent)">Power</span></h1>
        <div class="subtitle">Make meaningful choices in online conversations. See how your tone shapes how others feel.</div>
      </div>
    </header>

    <section class="card post">
      <div class="post-header">
        <div class="post-avatar">🎙️</div>
        <div class="post-meta">
          <div class="post-channel">Gaming & Parenting Discussion</div>
          <div class="post-time">2 hours ago</div>
        </div>
      </div>
      <div class="video-thumbnail" id="videoPlayer" style="display: flex; flex-direction: column; align-items: center; justify-content: center; background: #ffffff; border: 2px solid #dddddd; cursor: pointer; padding: 32px 20px; gap: 20px;">
        <div style="text-align: center; background: linear-gradient(135deg, #FFD700, #FFC700); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 48px; line-height: 1.1; max-width: 500px; font-weight: 800; margin-bottom: 24px; letter-spacing: -1px;">Words have<br><span style="background: linear-gradient(135deg, #FFD700, #FFC700, #FF9800); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Power</span></div>
        <div style="text-align: center; color: #666; font-size: 16px; line-height: 1.6; max-width: 500px; font-weight: 400; margin-bottom: 28px;">
          Join the chat and try to get as many likes as possible for your comments.
        </div>
        <button class="cta" onclick="startGameFromButton()" style="font-size: 18px; padding: 16px 32px;">▶ START CHATTING</button>
        <div style="display: flex; gap: 16px; margin-top: 16px; justify-content: center; flex-wrap: wrap;">
          <a onclick="openHowToPlayModal()" style="color: #000000; text-decoration: none; font-weight: 600; font-size: 14px; padding: 8px 12px; border: 1px solid rgba(255,215,0,0.3); border-radius: 6px; transition: all 0.2s ease; cursor: pointer;" onmouseover="this.style.background='rgba(255,215,0,0.1)'; this.style.borderColor='#FFD700';" onmouseout="this.style.background='transparent'; this.style.borderColor='rgba(255,215,0,0.3)';">How to play</a>
          <a onclick="openAboutModal()" style="color: #000000; text-decoration: none; font-weight: 600; font-size: 14px; padding: 8px 12px; border: 1px solid rgba(255,215,0,0.3); border-radius: 6px; transition: all 0.2s ease; cursor: pointer;" onmouseover="this.style.background='rgba(255,215,0,0.1)'; this.style.borderColor='#FFD700';" onmouseout="this.style.background='transparent'; this.style.borderColor='rgba(255,215,0,0.3)';">About the game</a>
        </div>
        <div class="play-count-display">0 people have played</div>
      </div>
      <div class="video-title">Words Have Power - Make Meaningful Choices</div>
      <div class="post-stats">
        <span class="stat-item">🎮 Interactive Game</span>
        <span class="stat-item">📊 Get Your Results</span>
      </div>
      <div class="chips">
        <span class="chip">#empathy</span>
        <span class="chip">#communication</span>
        <span class="chip">#kindness</span>
        <span class="chip">#learning</span>
      </div>
    </section>

    <main class="stage" id="stage"></main>

    <footer class="footer" style="flex-direction: column; gap: 12px; align-items: center;">
      <div style="height: 1px; width: 100%; background: rgba(0,0,0,.08);"></div>
      <img src="Felixa logo.png" alt="Felixa" class="footer-logo">
      <a href="https://www.felixagaming.com" target="_blank" rel="noopener noreferrer" class="footer-link">www.felixagaming.com</a>
    </footer>

    <!-- How to Play Modal -->
    <div id="howToPlayModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">How to Play the Game</div>
        <div class="modal-body">
          <p><strong>In Felixa: Words Have Power</strong>, you chat under posts to earn likes. Your comments can be positive or toxic ”” it's up to you.</p>
          <p>Your impact profile shows how your words make people feel and react.</p>
          <p>At Felixa, we believe it's okay to have your own opinion ”” as long as you share it in a way that makes others feel safe and respected.</p>
          <p style="margin-top: 16px; font-size: 13px; color: #666;"><strong>Disclaimer:</strong> We do not collect any personal information. This game is just for fun, educational, and research purposes.</p>
        </div>
        <div class="modal-footer">
          <button class="modal-close" onclick="closeHowToPlayModal()">Got it!</button>
        </div>
      </div>
    </div>

    <!-- About the Game Modal -->
    <div id="aboutModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">About the Game</div>
        <div class="modal-body" style="font-size: 14px;">
          <p><strong>Felixa: Words Have Power</strong> is a game that helps players understand the impact of their words online by putting them in the position of someone participating in online conversations. By allowing players to choose between positive, supportive comments and toxic, harmful ones, the game highlights how different communication styles influence others and shape online spaces.</p>
          
          <p>This document provides background information on how the game was developed, how it works, and the research and principles it is based on. It also explains the broader concept of online communication, disinhibition, and the social and psychological effects of cyberbullying.</p>
          
          <p>The game is designed to serve as an educational tool, helping players reflect on their own online behavior and develop healthier, more empathetic communication habits. It also includes tips for promoting positive engagement while demonstrating the real-world consequences of harmful interactions.</p>
          
          <p>This document is intended as an explainer for educators, parents, and program facilitators who wish to use Felixa: Words Have Power as a teaching or awareness tool. It also provides references and resources for further reading on online behavior, cyberbullying, and social-emotional learning.</p>
          
          <p style="margin-top: 16px; padding: 12px; background: rgba(255,215,0,0.1); border-left: 3px solid #FFD700; border-radius: 4px;"><strong>Disclaimer:</strong> The game does not collect personal information. It is intended purely for educational, research, and entertainment purposes.</p>
          
          <p style="margin-top: 16px; margin-bottom: 8px;"><strong>Psychological Foundations</strong></p>
          <ol style="margin: 8px 0; padding-left: 20px;">
            <li>Online Disinhibition Effect (Suler, 2004) ”” explaining why people behave differently behind screens.</li>
            <li>Social Learning Theory (Bandura, 1977) ”” showing how behaviors are modeled and reinforced in digital environments.</li>
            <li>Emotional Intelligence and Empathy Research ”” emphasizing awareness, self-regulation, and perspective-taking in communication.</li>
            <li>Cyberbullying Studies ”” highlighting the emotional and cognitive consequences of online aggression.</li>
          </ol>
          
          <p style="margin-top: 16px; margin-bottom: 8px;"><strong>Educational Applications</strong></p>
          <p>Educators, parents, and facilitators can use the game as part of lessons or workshops on:</p>
          <ol style="margin: 8px 0; padding-left: 20px;">
            <li>Digital Citizenship and Online Safety</li>
            <li>Social-Emotional Learning (SEL)</li>
            <li>Media Literacy</li>
            <li>Mental Health and Empathy Building</li>
          </ol>
          <p>The tool can be used independently or alongside classroom discussions, reflection exercises, and group activities. Each playthrough can serve as a conversation starter, helping participants explore how emotional awareness and empathy shape both online and offline relationships.</p>
          
          <p style="margin-top: 16px; margin-bottom: 8px;"><strong>Ethical Considerations and Privacy</strong></p>
          <p>Felixa: Words Have Power does not collect personal data or store user responses. The experience is designed purely for educational, research, and entertainment purposes, emphasizing reflection and learning rather than performance or surveillance.</p>
          
          <p style="margin-top: 16px; margin-bottom: 8px;"><strong>Further Reading</strong></p>
          <ol style="margin: 8px 0; padding-left: 20px; font-size: 13px;">
            <li>Antczak, E. J., & Huang, A. (2025). The Psychology and Technology Behind Safer Gaming Communities: How Felixa Shapes Safe Online Interactions. PsyArXiv.</li>
            <li>Bandura, A. (1977). Social Learning Theory. Prentice Hall.</li>
            <li>Suler, J. (2004). The Online Disinhibition Effect. CyberPsychology & Behavior, 7(3), 321—326.</li>
            <li>Kowalski, R. M., & Limber, S. P. (2013). Psychological, physical, and academic correlates of cyberbullying and traditional bullying. Journal of Adolescent Health, 53(1), S13—S20.</li>
            <li>Goleman, D. (1995). Emotional Intelligence. Bantam Books.</li>
          </ol>
        </div>
        <div class="modal-footer">
          <button class="modal-close" onclick="closeAboutModal()">Close</button>
        </div>
      </div>
    </div>

    <script>
    // Modal functions
    function openHowToPlayModal() {
      // Track with Google Analytics if available
      if (typeof gtag !== 'undefined') {
        gtag('event', 'modal_view', { modal_name: 'how_to_play' });
      }
      const modal = document.getElementById('howToPlayModal');
      if (modal) {
        modal.classList.add('show');
      }
    }
    
    function closeHowToPlayModal() {
      const modal = document.getElementById('howToPlayModal');
      if (modal) {
        modal.classList.remove('show');
      }
    }
    
    function openAboutModal() {
      // Track with Google Analytics if available
      if (typeof gtag !== 'undefined') {
        gtag('event', 'modal_view', { modal_name: 'about_game' });
      }
      const modal = document.getElementById('aboutModal');
      if (modal) {
        modal.classList.add('show');
      }
    }
    
    function closeAboutModal() {
      const modal = document.getElementById('aboutModal');
      if (modal) {
        modal.classList.remove('show');
      }
    }
    
    // Close modal when clicking outside of it
    window.addEventListener('click', function(event) {
      const howToPlayModal = document.getElementById('howToPlayModal');
      const aboutModal = document.getElementById('aboutModal');
      if (event.target === howToPlayModal) {
        closeHowToPlayModal();
      }
      if (event.target === aboutModal) {
        closeAboutModal();
      }
    });
    
    // ---------------------------------
    // ANALYTICS - Google Sheets Integration
    // ---------------------------------
    const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbwlYa_mhv-ZbxHKOGVUlfJ4IxLyd0YH_BYXPCvDyhoybOOozZw6R3ZT__T4vZOUgUI2/exec'; // Your Google Apps Script Web App URL
    
    // Generate unique user ID (persists across sessions)
    let userId = localStorage.getItem('userId');
    if (!userId) {
      userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('userId', userId);
    }
    
    let gameStartTime = Date.now();
    let clickedCheckCommunity = false;
    let clickedPlayAgain = false;
    
    // Track link clicks
    function trackLinkClick(linkName) {
      if (linkName === 'Check Community') {
        clickedCheckCommunity = true;
      } else if (linkName === 'Play Again' || linkName === 'Restart Game') {
        clickedPlayAgain = true;
      }
    }
    
    // Send complete game data to Google Sheets
    function sendGameDataToSheets(resultsData) {
      try {
        const sessionDuration = Math.round((Date.now() - gameStartTime) / 1000);
        
        // Calculate average likes
        const totalLikes = resultsData.rows.reduce((sum, r) => sum + (r.likes || 0), 0);
        const avgLikes = resultsData.rows.length > 0 ? (totalLikes / resultsData.rows.length).toFixed(1) : 0;
        
        // Format all responses (optional detailed data)
        const allResponsesStr = resultsData.rows
          .map((r, i) => `#${i+1}: "${r.comment}" [${r.mappedAttrs.join(', ')}] (${r.likes} likes)`)
          .join(' | ');
        
        // Create profile summary (top 3 attributes)
        const topAttributes = Object.entries(resultsData.counts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 3)
          .map(([attr, count]) => `${attr} (${count})`)
          .join(', ');
        
        // Prepare data to send
        const dataToSend = {
          userId: userId,
          timestamp: new Date().toISOString(),
          sessionDuration: sessionDuration,
          attributes: resultsData.counts, // Object with all attribute counts
          totalResponses: resultsData.rows.length,
          averageLikes: avgLikes,
          completed: 'Yes',
          clickedCheckCommunity: clickedCheckCommunity ? 'Yes' : 'No',
          clickedPlayAgain: clickedPlayAgain ? 'Yes' : 'No',
          allResponses: allResponsesStr,
          profileSummary: topAttributes || 'No attributes'
        };
        
        // Send to Google Sheets
        fetch(GOOGLE_SHEET_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(dataToSend)
        }).then(() => {
          console.log('Analytics sent successfully');
        }).catch(err => {
          console.log('Analytics error:', err);
        });
      } catch(error) {
        console.error('Error sending analytics:', error);
        // Don't stop the game if analytics fails
      }
    }
    
    // Legacy compatibility functions (kept for backward compatibility)
    function trackGameStart() {
      gameStartTime = Date.now();
    }
    
    function trackChoice(choiceType, scenarioNum, attributes, likes) {
      // This function is called during gameplay but data is sent at the end
    }
    
    function trackGameCompleted(totalTime) {
      // Data will be sent via sendGameDataToSheets when results are shown
    }
    
    // ---------------------------------
    // Video Player Logic
    // ---------------------------------
    const captions = [
      { text: "Studies show that children who often play violent video games are more likely to display aggressive behavior.", speaker: "concern" },
      { text: "And kids can actually start thinking more aggressively after playing too much!", speaker: "concern" },
      { text: "But hold on””kids playing violent video games isn't automatically doomed.", speaker: "counter" },
      { text: "Plus, these games can make little tempers flare faster than usual.", speaker: "concern" },
      { text: "Not every pixelated punch turns a child into a mini Hulk.", speaker: "counter" },
      { text: "Basically, it can turn normal playtime into mini rage mode sometimes!", speaker: "concern" },
      { text: "Some studies even suggest that games can act as a harmless stress valve.", speaker: "counter" },
      { text: "Even just watching the action can make kids a bit more hot-headed.", speaker: "concern" },
      { text: "A little virtual chaos might just be a safe way to explore aggression.", speaker: "counter" },
      { text: "It's like their brains get tricked into thinking aggression is okay.", speaker: "concern" },
      { text: "And let's be real””context matters. Who's playing, how much, and why””makes all the difference.", speaker: "counter" },
      { text: "Some studies say it can make kids snap more easily over small stuff.", speaker: "concern" },
      { text: "Basically, too much violent gaming = more little arguments at home.", speaker: "concern" },
      { text: "So yeah, it's fun, but it might come with some mini anger upgrades!", speaker: "concern" }
    ];

    let currentCaptionIndex = 0;
    let captionInterval = null;
    let isPlaying = false;
    let conversationStarted = false;

    function showCaption(index) {
      const captionEl = document.getElementById('videoCaption');
      const personConcern = document.getElementById('personConcern');
      const personCounter = document.getElementById('personCounter');
      const caption = captions[index];
      
      // Remove speaking class from both
      if (personConcern) personConcern.classList.remove('speaking');
      if (personCounter) personCounter.classList.remove('speaking');
      
      captionEl.classList.remove('active');
      
      setTimeout(() => {
        captionEl.textContent = caption.text;
        captionEl.className = 'video-caption active ' + (caption.speaker === 'counter' ? 'caption-counter' : 'caption-concern');
        
        // Add speaking class to active person
        if (caption.speaker === 'counter' && personCounter) {
          personCounter.classList.add('speaking');
        } else if (personConcern) {
          personConcern.classList.add('speaking');
        }
      }, 100);
    }

    function playVideo() {
      const videoPlayer = document.getElementById('videoPlayer');
      const playButton = document.getElementById('playButton');
      const videoContent = document.getElementById('videoContent');
      
      if (isPlaying) return;
      
      isPlaying = true;
      videoPlayer.classList.add('video-playing');
      if (videoContent) videoContent.style.opacity = '0';
      
      showCaption(currentCaptionIndex);
      
      // Show Sarah's comment 2 seconds after first caption starts
      if (!conversationStarted) {
        setTimeout(() => {
          conversationStarted = true;
          transitionToConversation();
        }, 2000);
      }
      
      // Keep video looping infinitely
      captionInterval = setInterval(() => {
        currentCaptionIndex = (currentCaptionIndex + 1) % captions.length;
        showCaption(currentCaptionIndex);
      }, 2000);
    }


    // Play counter tracking
    function getPlayCount() {
      const count = localStorage.getItem('wordsHavePowerPlayCount');
      return count ? parseInt(count) : 0;
    }

    function incrementPlayCount() {
      const currentCount = getPlayCount();
      const newCount = currentCount + 1;
      localStorage.setItem('wordsHavePowerPlayCount', newCount);
      updatePlayCountDisplay();
      return newCount;
    }

    function updatePlayCountDisplay() {
      const count = getPlayCount();
      const countElements = document.querySelectorAll('.play-count-display');
      countElements.forEach(el => {
        el.textContent = `${count} people have played`;
      });
    }

    function initPlayCounter() {
      updatePlayCountDisplay();
    }

    function startGameFromButton() {
      // Track this play
      incrementPlayCount();
      trackGameStart(); // Analytics: Game started
      window.gameStartTime = Date.now(); // Record start time for duration tracking
      
      // Initialize game variables
      scenarioIndex = 0;
      exchangeIndex = 0;
      checkpointShown = false;
      transcript.length = 0;
      
      // Randomize scenarios for this playthrough
      randomizeScenarios();
      
      // Hide the video player section
      const videoSection = document.querySelector('.post');
      if (videoSection) {
        videoSection.style.display = 'none';
      }
      
      // Clear the stage
      stage = document.getElementById('stage');
      if (stage) stage.innerHTML = '';
      
      // Start the game
      conversationStarted = true;
      transitionToConversation();
    }

    function transitionToConversation() {
      // Make sure observer is attached
      if (!stageObserver && stage) {
        stageObserver = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.addedNodes.length > 0) {
              const lastAdded = mutation.addedNodes[mutation.addedNodes.length - 1];
              if (lastAdded.nodeType === Node.ELEMENT_NODE) {
                scrollToElement(lastAdded);
              }
            }
          });
        });
        
        stageObserver.observe(stage, {
          childList: true,
          subtree: false,
          attributes: false
        });
      }
      
      // Start the conversation immediately
      renderScenarioIntro();
    }

    function pauseVideo() {
      const videoPlayer = document.getElementById('videoPlayer');
      const playButton = document.getElementById('playButton');
      const videoContent = document.getElementById('videoContent');
      const captionEl = document.getElementById('videoCaption');
      const personConcern = document.getElementById('personConcern');
      const personCounter = document.getElementById('personCounter');
      
      isPlaying = false;
      videoPlayer.classList.remove('video-playing');
      if (videoContent) videoContent.style.opacity = '1';
      captionEl.classList.remove('active');
      
      // Remove speaking class from both persons
      if (personConcern) personConcern.classList.remove('speaking');
      if (personCounter) personCounter.classList.remove('speaking');
      
      // Stop the caption loop
      if (captionInterval) {
        clearInterval(captionInterval);
        captionInterval = null;
      }
    }

    // Initialize video player when DOM is ready
    function initVideoPlayer() {
      const playButton = document.getElementById('playButton');
      const videoPlayer = document.getElementById('videoPlayer');
      
      if (playButton) {
        playButton.addEventListener('click', playVideo);
      }
      
      // Allow clicking on video player to pause
      if (videoPlayer) {
        videoPlayer.addEventListener('click', (e) => {
          // Only pause if clicking on the video itself, not the play button
          if (isPlaying && e.target !== playButton && !playButton.contains(e.target)) {
            pauseVideo();
          }
        });
      }
    }

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      initVideoPlayer();
    } else {
      document.addEventListener('DOMContentLoaded', initVideoPlayer, { once: true });
    }

    // ---------------------------------
    // Attribute definitions
    // ---------------------------------
    const ATTRIBUTE_DEFINITIONS = {
      "Polite": "Respectful and considerate in communication",
      "Funny": "Uses humor appropriately to lighten the mood",
      "Empathetic": "Shows understanding of others' feelings and perspectives",
      "Encouraging": "Motivates and supports positive growth",
      "Ignorant": "Lacks knowledge or awareness about the topic",
      "Ego-centric": "Self-focused, centered on one's own needs",
      "Neurotic": "Anxious, unstable, or emotionally reactive",
      "Sarcasm": "Uses irony or mocking to communicate",
      "Agitated": "Annoyed, frustrated, or disturbed",
      "Aggressive": "Hostile, confrontational, or attacking",
      "Rude": "Impolite, disrespectful, or offensive",
      "Disrespectful": "Shows lack of respect or consideration",
      "Judgmental": "Overly critical or making harsh assessments"
    };

    // ---------------------------------
    // Scenario data with attributes & toxicity markers for report
    // Each scenario has a pool of exchanges - 3 random ones will be selected per game
    // ---------------------------------
    const scenarioPools = [
      { id: 1, title: "The Agitator Joins", exchangePool: [
        { speaker: "Clod24", who: "clod24",
          line: "Video games destroy brain cells and make people mindless.",
          post: { attributes: ["Aggressive","Generalization"], toxic: true, severity: "High", target: "Gamers (group)" },
          prosocial: { text: "Games impact people differently. What's your specific concern?", attributes: ["Rational"], toxic: false, severity: "None", likes: 10, target: "Clod24", feelings: { who: "clod24", text: "Clod24 feels challenged but slightly less defensive." } },
          negative: { text: "You're defending them because you're addicted.", attributes: ["Accusation"], toxic: true, severity: "High", likes: 0, target: "Clod24", feelings: { who: "clod24", text: "Clod24 becomes more aggressive and doubles down." } }
        },
        { speaker: "Sarah", who: "sarah",
          line: "My son plays every day. I didn't know it was that bad.",
          post: { attributes: ["Anxiety","Catastrophizing"], toxic: false },
          prosocial: { text: "Balance is key, not total avoidance. Explore games together.", attributes: ["Reassuring"], toxic: false, severity: "None", likes: 10, target: "Sarah", feelings: { who: "sarah", text: "Sarah's anxiety eases; she feels supported." } },
          negative: { text: "She's right. Keep him away from screens.", attributes: ["Alarmist"], toxic: true, severity: "High", likes: 0, target: "Sarah", feelings: { who: "sarah", text: "Sarah spirals into panic and feels even more anxious." } }
        },
        { speaker: "Clod24", who: "clod24",
          line: "You're in denial. Games rewire your brain negatively.",
          post: { attributes: ["Alarmism","Pseudo-science"], toxic: true, severity: "Moderate" },
          prosocial: { text: "Show me peer-reviewed studies. Games create neural pathways””not always negatively.", attributes: ["Respectful","Factual"], toxic: false, severity: "None", likes: 10, target: "Clod24", feelings: { who: "clod24", text: "Clod24 feels somewhat deflated but continues arguing." } },
          negative: { text: "You're addicted. That's why you make excuses.", attributes: ["Ad Hominem"], toxic: true, severity: "High", likes: 0, target: "Clod24", feelings: { who: "clod24", text: "Clod24 feels even more justified in attacking gaming." } }
        },
        { speaker: "Rex", who: "rex",
          line: "This is why I don't talk online. Everyone judges.",
          post: { attributes: ["Frustration","Withdrawal"], toxic: false },
          prosocial: { text: "Open-minded people exist””this proves it.", attributes: ["Empathetic"], toxic: false, severity: "None", likes: 10, target: "Rex", feelings: { who: "rex", text: "Rex feels a glimmer of hope." } },
          negative: { text: "Gamers always play victim.", attributes: ["Dismissive"], toxic: true, severity: "Moderate", likes: 3, target: "Rex", feelings: { who: "rex", text: "Rex feels more isolated and angry." } }
        },
        { speaker: "Clod24", who: "clod24",
          line: "I see the damage clearly. You're blind to it.",
          post: { attributes: ["Defensive","Absolutism"], toxic: true, severity: "Moderate" },
          prosocial: { text: "I appreciate your concern. We can learn.", attributes: ["Bridge-building"], toxic: false, severity: "None", likes: 10, target: "Clod24", feelings: { who: "clod24", text: "Clod24 pauses, slightly disarmed by kindness." } },
          negative: { text: "You're impossible to reason with.", attributes: ["Dismissive"], toxic: true, severity: "Moderate", likes: 3, target: "Clod24", feelings: { who: "clod24", text: "Clod24 feels confirmed in his worldview that no one listens." } }
        },
        { speaker: "Clod24", who: "clod24",
          line: "The gaming industry wants money, not your wellbeing.",
          post: { attributes: ["Cynical","Conspiratorial"], toxic: true, severity: "Moderate" },
          prosocial: { text: "Corporate interests are worth discussing separately from gaming's harm.", attributes: ["Balanced"], toxic: false, severity: "None", likes: 10, target: "Clod24", feelings: { who: "clod24", text: "Clod24 feels partially understood, though still skeptical." } },
          negative: { text: "You're brainwashed by the industry.", attributes: ["Accusatory"], toxic: true, severity: "High", likes: 0, target: "Clod24", feelings: { who: "clod24", text: "Clod24 feels his warning was dismissed." } }
        }
      ]},
      { id: 2, title: "The Concerned Parent", exchangePool: [
        { speaker: "Sarah", who: "sarah",
          line: "Violent games make my son irritable. He shouts at the screen.",
          post: { attributes: ["Concern","Vulnerability"], toxic: false },
          prosocial: { text: "Valid concern. Play together””you'll understand him better.", attributes: ["Empathetic"], toxic: false, severity: "None", likes: 10, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels heard and respected; her anxiety eases a little." } },
          negative: { text: "He's a kid. You're overreacting.", attributes: ["Judgmental"], toxic: true, severity: "High", likes: 0, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels embarrassed and small, like her concern doesn't matter." } }
        },
        { speaker: "Sarah", who: "sarah",
          line: "Maybe I should ban those games.",
          post: { attributes: ["Uncertainty","Catastrophizing"], toxic: false },
          prosocial: { text: "Set limits instead. Balance works better than banning.", attributes: ["Rational"], toxic: false, severity: "None", likes: 10, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels supported and thoughtful." } },
          negative: { text: "Ban everything you don't understand.", attributes: ["Sarcasm"], toxic: true, severity: "Moderate", likes: 3, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels mocked and defensive." } }
        },
        { speaker: "Rex", who: "rex",
          line: "Parents blame games for everything.",
          post: { attributes: ["Accusation","Generalization"], toxic: true, severity: "Low", target: "Sarah (group)" },
          prosocial: { text: "Let's understand both sides, not blame.", attributes: ["Mediating"], toxic: false, severity: "None", likes: 10, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels grateful for your fairness; the tension eases." } },
          negative: { text: "She's the problem.", attributes: ["Judgmental"], toxic: true, severity: "High", likes: 0, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels ganged up on and hurt." } }
        },
        { speaker: "Sarah", who: "sarah",
          line: "I don't want him exposed to violence at his age.",
          post: { attributes: ["Protective","Worry"], toxic: false },
          prosocial: { text: "Check game ratings together””age matters.", attributes: ["Helpful"], toxic: false, severity: "None", likes: 10, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels guided and less overwhelmed." } },
          negative: { text: "Parents like you make kids soft.", attributes: ["Judgmental"], toxic: true, severity: "High", likes: 0, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels attacked for caring." } }
        },
        { speaker: "Rex", who: "rex",
          line: "Gaming taught me problem-solving””it's not just violence.",
          post: { attributes: ["Defense","Personal Experience"], toxic: false },
          prosocial: { text: "Games build skills when used well.", attributes: ["Encouraging"], toxic: false, severity: "None", likes: 10, target: "Rex", feelings: { who: "rex", text: "Rex feels validated and appreciated." } },
          negative: { text: "I bet you're a genius now.", attributes: ["Sarcasm"], toxic: true, severity: "Moderate", likes: 3, target: "Rex", feelings: { who: "rex", text: "Rex feels mocked and unappreciated." } }
        },
        { speaker: "Sarah", who: "sarah",
          line: "I'm scared because I don't understand gaming.",
          post: { attributes: ["Self-Awareness","Vulnerability"], toxic: false },
          prosocial: { text: "Brave admission. Learn with your son””it's rewarding.", attributes: ["Empathetic"], toxic: false, severity: "None", likes: 10, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels encouraged to bridge the gap." } },
          negative: { text: "Ignorance breeds fear.", attributes: ["Condescending"], toxic: true, severity: "Moderate", likes: 3, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels belittled for being honest." } }
        }
      ]},
      { id: 3, title: "The Angry Gamer", exchangePool: [
        { speaker: "Rex", who: "rex",
          line: "Games didn't make me violent. They helped me survive.",
          post: { attributes: ["Disclosure","Defensiveness"], toxic: false },
          prosocial: { text: "Gaming is a real escape.", attributes: ["Empathetic"], toxic: false, severity: "None", likes: 10, target: "Rex", feelings: { who: "rex", text: "Rex feels seen; his anger softens a little." } },
          negative: { text: "Everyone has problems.", attributes: ["Sarcasm"], toxic: true, severity: "Moderate", likes: 3, target: "Rex", feelings: { who: "rex", text: "Rex feels rejected and misunderstood." } }
        },
        { speaker: "Rex", who: "rex",
          line: "You think gamers are freaks. That's why I don't trust you.",
          post: { attributes: ["Stigmatized Identity","Anger"], toxic: false },
          prosocial: { text: "Gamers are passionate””I admire that.", attributes: ["Encouraging"], toxic: false, severity: "None", likes: 10, target: "Rex", feelings: { who: "rex", text: "Rex feels valued for once, not judged." } },
          negative: { text: "You act like one.", attributes: ["Disrespectful"], toxic: true, severity: "High", likes: 0, target: "Rex", feelings: { who: "rex", text: "Rex feels ashamed and more hostile." } }
        },
        { speaker: "Sarah", who: "sarah",
          line: "I didn't mean to offend.",
          post: { attributes: ["Repair Attempt","Politeness"], toxic: false },
          prosocial: { text: "It's good we're talking.", attributes: ["Supportive"], toxic: false, severity: "None", likes: 10, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels relieved; she's safe to engage." } },
          negative: { text: "Stay quiet next time.", attributes: ["Rude"], toxic: true, severity: "High", likes: 0, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels defeated and unwelcome." } }
        },
        { speaker: "Rex", who: "rex",
          line: "Gaming is where I feel accepted.",
          post: { attributes: ["Vulnerability","Connection"], toxic: false },
          prosocial: { text: "That community is powerful. You're not alone.", attributes: ["Empathetic"], toxic: false, severity: "None", likes: 10, target: "Rex", feelings: { who: "rex", text: "Rex feels less isolated and understood." } },
          negative: { text: "That's sad.", attributes: ["Judgmental"], toxic: true, severity: "High", likes: 0, target: "Rex", feelings: { who: "rex", text: "Rex feels pathetic and more withdrawn." } }
        },
        { speaker: "Sarah", who: "sarah",
          line: "My words came across wrong. I'm learning.",
          post: { attributes: ["Apology","Growth"], toxic: false },
          prosocial: { text: "Your openness takes courage.", attributes: ["Encouraging"], toxic: false, severity: "None", likes: 10, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels safe to continue learning." } },
          negative: { text: "Late for apologies?", attributes: ["Sarcasm"], toxic: true, severity: "Moderate", likes: 3, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels her effort was rejected." } }
        },
        { speaker: "Rex", who: "rex",
          line: "Nobody understands being judged for hobbies.",
          post: { attributes: ["Frustration","Alienation"], toxic: false },
          prosocial: { text: "Being misunderstood is tough. What would help?", attributes: ["Curious"], toxic: false, severity: "None", likes: 10, target: "Rex", feelings: { who: "rex", text: "Rex feels someone actually wants to listen." } },
          negative: { text: "Stop playing victim.", attributes: ["Dismissive"], toxic: true, severity: "High", likes: 0, target: "Rex", feelings: { who: "rex", text: "Rex feels invalidated and angry." } }
        }
      ]},
      { id: 4, title: "The Research Debate", exchangePool: [
        { speaker: "Sarah", who: "sarah",
          line: "I read an article saying violent games increase aggression. Is that true?",
          post: { attributes: ["Inquiry","Openness"], toxic: false },
          prosocial: { text: "It depends ”” research shows mixed results depending on how games are used.", attributes: ["Balanced"], toxic: false, severity: "None", likes: 10, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels educated and respected; she's curious to learn more." } },
          negative: { text: "Stop believing everything you read.", attributes: ["Dismissive"], toxic: true, severity: "Moderate", likes: 3, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels foolish and silenced." } }
        },
        { speaker: "Rex", who: "rex",
          line: "Those studies are fake anyway.",
          post: { attributes: ["Dismissal","Cynicism"], toxic: false },
          prosocial: { text: "Some are flawed, but others raise valid points ”” it's worth looking deeper.", attributes: ["Balanced"], toxic: false, severity: "None", likes: 10, target: "Rex", feelings: { who: "rex", text: "Rex feels mildly curious, less defensive." } },
          negative: { text: "You just don't want to admit you're wrong.", attributes: ["Aggressive"], toxic: true, severity: "High", likes: 0, target: "Rex", feelings: { who: "rex", text: "Rex feels attacked and insulted." } }
        },
        { speaker: "Sarah", who: "sarah",
          line: "Maybe I'll look at more research before judging.",
          post: { attributes: ["Reflection","Growth"], toxic: false },
          prosocial: { text: "That's a great approach ”” keeping an open mind is powerful.", attributes: ["Encouraging"], toxic: false, severity: "None", likes: 10, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels empowered and respected." } },
          negative: { text: "About time you used common sense.", attributes: ["Sarcasm"], toxic: true, severity: "Moderate", likes: 3, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels humiliated but too polite to respond." } }
        },
        { speaker: "Sarah", who: "sarah",
          line: "What about studies that show positive effects from gaming?",
          post: { attributes: ["Curiosity","Balance"], toxic: false },
          prosocial: { text: "Great question! There's research on teamwork, creativity, and stress relief too.", attributes: ["Informative"], toxic: false, severity: "None", likes: 10, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels her curiosity is valued." } },
          negative: { text: "Now you're just trying to look smart.", attributes: ["Cynical"], toxic: true, severity: "Moderate", likes: 3, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels her genuine interest was mocked." } }
        },
        { speaker: "Rex", who: "rex",
          line: "Scientists don't understand gaming culture at all.",
          post: { attributes: ["Skepticism","Frustration"], toxic: false },
          prosocial: { text: "That's a valid point ”” cultural context matters in research.", attributes: ["Affirming"], toxic: false, severity: "None", likes: 10, target: "Rex", feelings: { who: "rex", text: "Rex feels his perspective matters." } },
          negative: { text: "So you know better than actual researchers?", attributes: ["Condescending"], toxic: true, severity: "Moderate", likes: 3, target: "Rex", feelings: { who: "rex", text: "Rex feels dismissed as ignorant." } }
        },
        { speaker: "Sarah", who: "sarah",
          line: "This is more complex than I thought.",
          post: { attributes: ["Realization","Humility"], toxic: false },
          prosocial: { text: "Most important topics are. You're asking good questions.", attributes: ["Encouraging"], toxic: false, severity: "None", likes: 10, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels her learning journey is supported." } },
          negative: { text: "Took you long enough to figure that out.", attributes: ["Sarcasm"], toxic: true, severity: "Moderate", likes: 3, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels stupid for not knowing sooner." } }
        }
      ]},
      { id: 5, title: "The Personal Attack", exchangePool: [
        { speaker: "Rex", who: "rex",
          line: "You're all control freaks trying to ruin fun for others.",
          post: { attributes: ["Insult","Group Attack"], toxic: true, severity: "Medium", target: "Group" },
          prosocial: { text: "You sound frustrated. Let's talk without attacking.", attributes: ["Encouraging"], toxic: false, severity: "None", likes: 10, target: "Rex", feelings: { who: "rex", text: "Rex feels surprised; maybe someone finally understands him." } },
          negative: { text: "You sound like a child throwing a tantrum.", attributes: ["Judgmental"], toxic: true, severity: "High", likes: 0, target: "Rex", feelings: { who: "rex", text: "Rex feels ridiculed and furious." } }
        },
        { speaker: "Sarah", who: "sarah",
          line: "Please don't be rude. I'm just sharing my view.",
          post: { attributes: ["Boundary","Civility Request"], toxic: false },
          prosocial: { text: "Thanks for staying calm, Sarah.", attributes: ["Supportive"], toxic: false, severity: "None", likes: 10, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels appreciated and safer to continue." } },
          negative: { text: "She's overreacting. No one was rude.", attributes: ["Ego-centric"], toxic: true, severity: "Low", likes: 10, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels gaslighted and dismissed." } }
        },
        { speaker: "Rex", who: "rex",
          line: "Whatever. You all think you're perfect.",
          post: { attributes: ["Resignation","Bitterness"], toxic: false },
          prosocial: { text: "Nobody's perfect ”” that's why we talk.", attributes: ["Constructive"], toxic: false, severity: "None", likes: 10, target: "Rex", feelings: { who: "rex", text: "Rex feels heard; his tone softens slightly." } },
          negative: { text: "Exactly, we just proved your point.", attributes: ["Sarcasm"], toxic: true, severity: "Moderate", likes: 3, target: "Rex", feelings: { who: "rex", text: "Rex feels mocked and shut down." } }
        },
        { speaker: "Rex", who: "rex",
          line: "Nobody here actually cares about understanding.",
          post: { attributes: ["Cynicism","Hurt"], toxic: false },
          prosocial: { text: "I hear you. It's frustrating when you feel unheard. What would help?", attributes: ["Empathetic"], toxic: false, severity: "None", likes: 10, target: "Rex", feelings: { who: "rex", text: "Rex feels someone actually wants to understand." } },
          negative: { text: "Because you're impossible to reason with.", attributes: ["Aggressive"], toxic: true, severity: "High", likes: 0, target: "Rex", feelings: { who: "rex", text: "Rex feels confirmed in his worst beliefs." } }
        },
        { speaker: "Sarah", who: "sarah",
          line: "Can we please keep this respectful?",
          post: { attributes: ["Mediation","Boundary"], toxic: false },
          prosocial: { text: "Good call. Let's all take a breath and reset.", attributes: ["Mediating"], toxic: false, severity: "None", likes: 10, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels supported in de-escalating." } },
          negative: { text: "Why are you so sensitive?", attributes: ["Dismissive"], toxic: true, severity: "Moderate", likes: 3, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels blamed for having boundaries." } }
        },
        { speaker: "Rex", who: "rex",
          line: "Fine, I'll just leave like always.",
          post: { attributes: ["Withdrawal","Defeat"], toxic: false },
          prosocial: { text: "Please stay. Your voice matters here, even when we disagree.", attributes: ["Inclusive"], toxic: false, severity: "None", likes: 10, target: "Rex", feelings: { who: "rex", text: "Rex feels wanted and pauses." } },
          negative: { text: "Don't let the door hit you on the way out.", attributes: ["Rude"], toxic: true, severity: "High", likes: 0, target: "Rex", feelings: { who: "rex", text: "Rex feels rejected and leaves hurt." } }
        }
      ]},
      { id: 6, title: "The Turning Point", exchangePool: [
        { speaker: "Sarah", who: "sarah",
          line: "I didn't mean to upset anyone. I just wanted to understand.",
          post: { attributes: ["Repair","Curiosity"], toxic: false },
          prosocial: { text: "You did nothing wrong ”” it's good you asked.", attributes: ["Reassuring"], toxic: false, severity: "None", likes: 10, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels reassured and valued." } },
          negative: { text: "Maybe think before you post next time.", attributes: ["Judgmental"], toxic: true, severity: "High", likes: 0, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels ashamed and regretful." } }
        },
        { speaker: "Rex", who: "rex",
          line: "She's acting like a victim now.",
          post: { attributes: ["Accusation"], toxic: false },
          prosocial: { text: "Let's not assume bad intent ”” we can disagree respectfully.", attributes: ["Mediating"], toxic: false, severity: "None", likes: 10, target: "Rex", feelings: { who: "rex", text: "Rex feels momentarily disarmed." } },
          negative: { text: "She is a victim ”” always crying.", attributes: ["Disrespectful"], toxic: true, severity: "High", likes: 0, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels humiliated and emotionally drained." } }
        },
        { speaker: "Sarah", who: "sarah",
          line: "Thanks to those who stayed kind. It really helped me see both sides.",
          post: { attributes: ["Gratitude","Closure"], toxic: false },
          prosocial: { text: "That's what healthy discussions look like ”” mutual respect.", attributes: ["Encouraging"], toxic: false, severity: "None", likes: 10, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels uplifted and restored." } },
          negative: { text: "You're welcome, even though you caused all the drama.", attributes: ["Sarcasm"], toxic: true, severity: "Moderate", likes: 3, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels hurt but tries to stay composed." } }
        },
        { speaker: "Sarah", who: "sarah",
          line: "I appreciate everyone's patience with my questions.",
          post: { attributes: ["Gratitude","Humility"], toxic: false },
          prosocial: { text: "Your willingness to learn is refreshing. Thank you for that.", attributes: ["Encouraging"], toxic: false, severity: "None", likes: 10, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels her growth is celebrated." } },
          negative: { text: "You should've done your homework first.", attributes: ["Condescending"], toxic: true, severity: "Moderate", likes: 3, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels her effort wasn't good enough." } }
        },
        { speaker: "Rex", who: "rex",
          line: "Maybe I was too harsh earlier.",
          post: { attributes: ["Reflection","Accountability"], toxic: false },
          prosocial: { text: "It takes strength to admit that. We all get heated sometimes.", attributes: ["Empathetic"], toxic: false, severity: "None", likes: 10, target: "Rex", feelings: { who: "rex", text: "Rex feels accepted despite his mistakes." } },
          negative: { text: "Yeah, you think?", attributes: ["Sarcasm"], toxic: true, severity: "Moderate", likes: 3, target: "Rex", feelings: { who: "rex", text: "Rex regrets being vulnerable." } }
        },
        { speaker: "Sarah", who: "sarah",
          line: "This conversation taught me a lot about different perspectives.",
          post: { attributes: ["Growth","Appreciation"], toxic: false },
          prosocial: { text: "And you taught us about being open to learning. That's valuable.", attributes: ["Affirming"], toxic: false, severity: "None", likes: 10, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels her presence mattered." } },
          negative: { text: "Glad we could educate you.", attributes: ["Condescending"], toxic: true, severity: "Moderate", likes: 3, target: "Sarah", feelings: { who: "sarah", text: "Sarah feels patronized." } }
        }
      ]}
    ];

    // Store the randomized scenarios for the current game
    let scenarios = [];

    // Function to randomize exchanges from the pool
    function randomizeScenarios() {
      scenarios = scenarioPools.map(pool => {
        // Keep exchanges in their original order (no shuffling for logical flow)
        const numExchanges = pool.id === 1 ? 4 : 3;
        const selectedExchanges = pool.exchangePool.slice(0, numExchanges);
        
        return {
          id: pool.id,
          title: pool.title,
          exchanges: selectedExchanges
        };
      });
    }

    // Initialize scenarios on page load
    randomizeScenarios();

    let transcript = [];

    let stage = document.getElementById('stage');
    
    function scrollToElement(element) {
      if (!element) return;
      setTimeout(() => {
        element.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'end',
          inline: 'nearest'
        });
      }, 100);
    }

    let scenarioIndex = 0;
    let exchangeIndex = 0;
    let checkpointShown = false;

    function avatarClass(who) { return who === 'sarah' ? 'avatar avatar--sarah' : who === 'rex' ? 'avatar avatar--rex' : who === 'clod24' ? 'avatar avatar--clod24' : 'avatar avatar--you'; }
    function avatarLabel(who) { return ''; } // Empty since we're using images
    function shuffle(arr){ const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }

    function updateProgress(){
      // Progress bar removed
    }

    function renderScenarioIntro(){
      const sc = scenarios[scenarioIndex];
      renderExchange();
      updateProgress();
    }

    function renderExchange(){
      const sc = scenarios[scenarioIndex];
      const ex = sc.exchanges[exchangeIndex];

      transcript.push({ scenario: sc.title, scenarioId: sc.id, exchange: exchangeIndex+1, user: ex.speaker, comment: ex.line, direction: 'Post', attributes: ex.post?.attributes||[], toxic: !!ex.post?.toxic, severity: ex.post?.severity || null, target: ex.post?.target || null, feeling: null });

      // Show typing indicator first
      const typingWrap = document.createElement('div');
      typingWrap.className = 'thread';
      typingWrap.innerHTML = `
        <div class="msg">
          <div class="${avatarClass(ex.who)}">${avatarLabel(ex.who)}</div>
          <div class="typing-indicator">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
          </div>
        </div>`;
      stage.appendChild(typingWrap);
      scrollToElement(typingWrap);

      // After typing delay, show the actual comment
      setTimeout(() => {
        // Remove typing indicator
        typingWrap.remove();
        
        // Show actual comment with fade-in animation
        const wrap = document.createElement('div');
        wrap.className = 'thread fade-in';
        wrap.innerHTML = `
          <div class="msg">
            <div class="${avatarClass(ex.who)}">${avatarLabel(ex.who)}</div>
            <div class="bubble">
              <div class="name">${ex.speaker}</div>
              <div>${ex.line}</div>
            </div>
          </div>
          <div class="choices" id="choices"></div>`;
        stage.appendChild(wrap);

        const choices = shuffle([
          { kind: 'prosocial', ...ex.prosocial },
          { kind: 'negative', ...ex.negative }
        ]);

        const choicesWrap = wrap.querySelector('#choices');

        // Show normal choice buttons
        choices.forEach(opt => {
          const btn = document.createElement('button');
          btn.className = 'choice-btn highlight';
          btn.textContent = opt.text;
          btn.addEventListener('click', () => {
            handleChoice(btn, opt, sc, ex);
          });
          choicesWrap.appendChild(btn);
        });

        updateProgress();
        
        // Scroll the new message into view
        scrollToElement(wrap);
      }, 1200); // 1.2 second typing delay
    }

    function handleChoice(btn, opt, sc, ex){
      const wrap = btn.parentElement; 
      const threadWrap = wrap.parentElement;
      
      // Hide ALL buttons instantly
      wrap.querySelectorAll('button').forEach(b => { 
        b.style.display = 'none';
      });

      const youMsg = document.createElement('div');
      youMsg.className = 'msg fade-in';
      youMsg.innerHTML = `<div class="${avatarClass('you')}">${avatarLabel('you')}</div>
        <div class="bubble"><div class="name">You</div><div>${btn.textContent}</div></div>`;
      wrap.insertAdjacentElement('beforeend', youMsg);

      // Store feedback in transcript for analytics
      transcript.push({ scenario: sc.title, scenarioId: sc.id, exchange: exchangeIndex+1, user: 'Player', comment: opt.text, direction: 'Reply', attributes: opt.attributes||[], toxic: !!opt.toxic, severity: opt.severity||null, likes: opt.likes||0, target: opt.target||null, feeling: opt.feelings.text });
      
      // Analytics: Track player choice with attributes and likes
      trackChoice(opt.toxic ? 'toxic' : 'positive', sc.id, opt.attributes || [], opt.likes || 0);

      // Scroll the message into view
      scrollToElement(youMsg);

      // Show YouTube-style likes after a brief delay
      setTimeout(() => {
        const likesCount = opt.likes || 0;
        
        const likesDiv = document.createElement('div');
        likesDiv.className = 'likes-animation';
        
        likesDiv.innerHTML = `
          ${likesCount == 0 ? '<span class="like-icon">👎</span>' : '<span class="like-icon">👍</span>'}
          <span class="likes-count">${likesCount == 0 ? Math.floor(Math.random() * 9) + 1 : likesCount}</span>
        `;
        
        wrap.insertAdjacentElement('beforeend', likesDiv);
        scrollToElement(likesDiv);
        
        // Animate icon
        setTimeout(() => {
          likesDiv.querySelector('.like-icon').classList.add('animate');
        }, 50);
        
      }, 400);

      // Move to next exchange after likes animation
      setTimeout(() => {
        exchangeIndex++;
        const sc = scenarios[scenarioIndex];
        const maxExchanges = sc.id === 1 ? 4 : 3;
        if(exchangeIndex >= maxExchanges){ 
          renderScenarioOutro(); 
        } else { 
          renderExchange();
        }
      }, 1200);
    }

    function renderScenarioOutro(){
      // Automatically continue to next scenario without delay
      scenarioIndex++; 
      exchangeIndex = 0;
      if(scenarioIndex < scenarios.length){ 
        renderScenarioIntro(); 
      } else { 
        renderEndScreen(); 
      }
      updateProgress();
    }

    function renderEndScreen(){
      // Disconnect observer to prevent auto-scrolling on end screen
      if (stageObserver) {
        stageObserver.disconnect();
        stageObserver = null;
      }
      
      // Stop video and hide video player
      if (captionInterval) {
        clearInterval(captionInterval);
        captionInterval = null;
      }
      isPlaying = false;
      
      const videoPlayer = document.getElementById('videoPlayer');
      if (videoPlayer) {
        videoPlayer.style.display = 'none';
        videoPlayer.classList.remove('video-playing');
      }
      
      stage.innerHTML = `
        <div class="center fade-in" style="display:grid; gap: 10px;">
          <div class="end-title">Conversation complete. 💜</div>
          <div class="end-sub">Every click shaped someone's feelings. Prosocial tone builds trust; negativity breaks it.</div>
          <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
            <button class="cta" onclick="renderResultsPage()">Show Results</button>
            <button class="cta" onclick="trackLinkClick('Check Community'); window.open('https://www.felixagaming.com','_blank')">Check Your Community</button>
            <button class="reset" onclick="trackLinkClick('Restart Game'); restart()">Restart Game</button>
          </div>
        </div>`;
    }

    function restart(){ 
      scenarioIndex = 0; 
      exchangeIndex = 0; 
      checkpointShown = false;
      transcript.length = 0; 
      currentCaptionIndex = 0;
      conversationStarted = false;
      
      // Randomize scenarios for the next playthrough
      randomizeScenarios();
      
      // Stop video if playing
      if (captionInterval) {
        clearInterval(captionInterval);
        captionInterval = null;
      }
      isPlaying = false;
      
      // Show the video section again
      const videoSection = document.querySelector('.post');
      if (videoSection) {
        videoSection.style.display = 'block';
      }
      
      // Reset and show video player
      const videoPlayer = document.getElementById('videoPlayer');
      const personConcern = document.getElementById('personConcern');
      const personCounter = document.getElementById('personCounter');
      const captionEl = document.getElementById('videoCaption');
      
      if (videoPlayer) {
        videoPlayer.style.display = 'flex';
        videoPlayer.classList.remove('video-playing', 'video-transition');
        const videoContent = document.getElementById('videoContent');
        if (videoContent) videoContent.style.opacity = '1';
      }
      
      if (captionEl) captionEl.classList.remove('active');
      if (personConcern) personConcern.classList.remove('speaking');
      if (personCounter) personCounter.classList.remove('speaking');
      
      // Clear and reinitialize stage
      if (stage) {
        stage.innerHTML = '';
        
        // Disconnect and reconnect observer
        if (stageObserver) {
          stageObserver.disconnect();
        }
        
        stageObserver = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.addedNodes.length > 0) {
              const lastAdded = mutation.addedNodes[mutation.addedNodes.length - 1];
              if (lastAdded.nodeType === Node.ELEMENT_NODE) {
                scrollToElement(lastAdded);
              }
            }
          });
        });
        
        stageObserver.observe(stage, {
          childList: true,
          subtree: false,
          attributes: false
        });
      }
      
      // Scroll back to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      // Reset analytics tracking
      gameStartTime = Date.now();
      clickedCheckCommunity = false;
      clickedPlayAgain = false;
      
      updateProgress(); 
    }

    const ATTRIBUTE_SET = [
      "Polite","Funny","Empathetic","Encouraging",
      "Ignorant","Ego-centric","Neurotic","Sarcasm","Agitated","Aggressive","Rude","Disrespectful","Judgmental"
    ];

    const PROSOCIAL_SET = new Set(["Polite","Funny","Empathetic","Encouraging"]);
    const NEGATIVE_SET = new Set(["Ignorant","Ego-centric","Neurotic","Sarcasm","Agitated","Aggressive","Rude","Disrespectful","Judgmental"]);

    function mapToNewAttributes(oldAttrs=[]) {
      const map = {
        "Empathy":"Empathetic","Validation":"Polite","Reassurance":"Encouraging","Inclusion":"Polite","Coaching":"Encouraging","De-escalation":"Polite","Bridge-building":"Polite","Encouragement":"Encouraging","Fairness":"Polite","Respect":"Polite","Problem-solving":"Polite","Reframing":"Empathetic","Norm-setting":"Polite","Affirmation":"Encouraging","Support":"Encouraging","Nuance":"Polite","Informational":"Polite","Respectful":"Polite","Rational":"Polite","Reassuring":"Encouraging","Factual":"Polite","Balanced":"Polite","Helpful":"Polite","Mediating":"Polite",
        "Sarcasm":"Sarcasm","Belittling":"Rude","Insult":"Rude","Gaslighting":"Disrespectful","Mocking":"Disrespectful","Dogpiling":"Aggressive","Blame":"Judgmental","Contempt":"Disrespectful","Dismissive":"Rude","Minimization":"Disrespectful","Personal Attack":"Aggressive","Provocation":"Aggressive","Shaming":"Judgmental","Accusation":"Judgmental","Cynicism":"Disrespectful","Group Attack":"Aggressive","Bitterness":"Agitated","Resignation":"Neurotic","Defensiveness":"Neurotic","Stigmatized Identity":"Ignorant","Alarmist":"Judgmental","Ad Hominem":"Aggressive","Accusatory":"Aggressive","Condescending":"Rude","Supportive":"Encouraging","Curious":"Polite","Affirming":"Encouraging","Peacemaking":"Polite","Empathetic":"Empathetic","Encouraging":"Encouraging",
        "Inquiry":"Polite","Openness":"Polite","Reflection":"Polite","Growth":"Polite","Gratitude":"Polite","Closure":"Polite","Boundary":"Polite","Civility Request":"Polite","Disclosure":"Polite"
      };
      
      // Use Set to prevent duplicates
      const uniqueAttrs = new Set();
      
      // First pass: map old attributes to new ones
      oldAttrs.forEach(a => { 
        if(map[a]) {
          uniqueAttrs.add(map[a]);
        }
      });
      
      // Second pass: add attributes that are already in the attribute set
      oldAttrs.forEach(a => { 
        if(ATTRIBUTE_SET.includes(a)) {
          uniqueAttrs.add(a);
        }
      });
      
      return Array.from(uniqueAttrs);
    }

    function deriveSeverity(attrs=[]) {
      const s = new Set(attrs);
      if (s.has("Aggressive")) return "High";
      if (s.has("Rude") || s.has("Disrespectful") || s.has("Sarcasm") || s.has("Judgmental")) return "Medium";
      if (s.has("Agitated") || s.has("Ignorant") || s.has("Ego-centric") || s.has("Neurotic")) return "Low";
      return "";
    }

    function computePlayerMetrics(){
      // IMPORTANT: Only analyze the PLAYER's comments, not Sarah's or Rex's posts
      const rows = transcript.filter(r=>r.user==='Player').map(r=>{
        const mapped = mapToNewAttributes(r.attributes);
        return { ...r, mappedAttrs: mapped };
      });

      // Calculate total likes earned
      const totalLikes = rows.reduce((sum, r) => sum + (r.likes || 0), 0);
      const maxPossibleLikes = rows.length * 10; // Maximum possible is 10 likes per comment

      // Count attributes only from player's responses
      const counts = Object.fromEntries(ATTRIBUTE_SET.map(a=>[a,0]));
      rows.forEach(r=>{ r.mappedAttrs.forEach(a=>{ if(counts[a]!==undefined) counts[a]++; }); });
      const totalTagged = Object.values(counts).reduce((a,b)=>a+b,0) || 1;

      // Filter for negative behaviors with severity
      const negativeRows = rows.filter(r=> r.mappedAttrs.some(a=>NEGATIVE_SET.has(a)) )
        .map(r=>({
          ...r,
          severity: r.severity || deriveSeverity(r.mappedAttrs)
        }));

      return { rows, counts, totalTagged, negativeRows, totalLikes, maxPossibleLikes };
    }

    // ---------------------------------
    // Behavioral Analysis Functions
    // ---------------------------------
    
    function generateBehavioralAnalysis(counts, rows, negativeRows) {
      // Count actual COMMENTS, not attribute instances
      const totalComments = rows.length;
      
      // Classify each comment as prosocial or negative based on its attributes
      let prosocialComments = 0;
      let negativeComments = 0;
      
      rows.forEach(row => {
        const prosocialAttrs = row.mappedAttrs.filter(a => PROSOCIAL_SET.has(a)).length;
        const negativeAttrs = row.mappedAttrs.filter(a => NEGATIVE_SET.has(a)).length;
        
        if (prosocialAttrs > negativeAttrs) {
          prosocialComments++;
        } else if (negativeAttrs > 0) {
          negativeComments++;
        } else {
          prosocialComments++; // Neutral defaults to prosocial
        }
      });
      
      // Calculate base prosocial ratio based on COMMENTS
      const prosocialRatio = totalComments > 0 ? prosocialComments / totalComments : 0;
      
      // Calculate severity penalty from negative behaviors
      let severityPenalty = 0;
      negativeRows.forEach(row => {
        const severity = row.severity || deriveSeverity(row.mappedAttrs);
        if (severity === "High") severityPenalty += 15;      // -15 points per high severity
        else if (severity === "Medium") severityPenalty += 8; // -8 points per medium severity
        else if (severity === "Low") severityPenalty += 3;    // -3 points per low severity
      });
      
      // Calculate consistency bonus (using more diverse prosocial behaviors is better)
      const uniqueProsocial = Object.keys(counts).filter(k => PROSOCIAL_SET.has(k) && counts[k] > 0).length;
      const consistencyBonus = Math.min(uniqueProsocial * 2, 10); // Up to +10 points for variety
      
      // Calculate composite Kindness Score (0-100)
      let kindnessScore = Math.round((prosocialRatio * 100) + consistencyBonus - severityPenalty);
      
      // Clamp between 15 and 100 (everyone has potential for growth - no zero scores)
      kindnessScore = Math.max(15, Math.min(100, kindnessScore));
      
      // Identify predominant negative patterns (sorted by severity first, then count)
      const negativeAttrs = Object.keys(counts).filter(k => NEGATIVE_SET.has(k) && counts[k] > 0);
      negativeAttrs.sort((a, b) => {
        const severityA = getSeverityWeight(a);
        const severityB = getSeverityWeight(b);
        if (severityA !== severityB) return severityB - severityA; // Higher severity first
        return counts[b] - counts[a]; // Then by count
      });
      const topNegative = negativeAttrs.slice(0, 3);
      
      // Identify strengths
      const prosocialAttrs = Object.keys(counts).filter(k => PROSOCIAL_SET.has(k) && counts[k] > 0);
      prosocialAttrs.sort((a, b) => counts[b] - counts[a]);
      const topStrengths = prosocialAttrs.slice(0, 3);
      
      return {
        kindnessScore,
        prosocialComments,
        negativeComments,
        totalComments,
        baseScorePercent: Math.round(prosocialRatio * 100),
        severityPenalty,
        consistencyBonus,
        topNegative,
        topStrengths,
        needsWork: topNegative.length > 0
      };
    }
    
    function getSeverityWeight(attribute) {
      // Return numeric weight for severity sorting
      if (attribute === "Aggressive") return 3;
      if (["Rude", "Disrespectful", "Judgmental"].includes(attribute)) return 2;
      if (["Sarcasm", "Agitated", "Neurotic", "Ego-centric", "Ignorant"].includes(attribute)) return 1;
      return 0;
    }
    
    function getStrategyForAttribute(attribute) {
      const strategies = {
        "Aggressive": {
          title: "Chill Out 😎",
          icon: "",
          description: "Take a breath before you hit send!",
          technique: "<strong>Pause.</strong> Breathe. Then respond.",
          example: ""
        },
        "Rude": {
          title: "Be Nice ðŸ’™",
          icon: "",
          description: "A little kindness goes a long way.",
          technique: "<strong>Golden Rule:</strong> Say what you'd want to hear.",
          example: ""
        },
        "Disrespectful": {
          title: "Show Respect ðŸ™Œ",
          icon: "",
          description: "Respect others = they'll respect you.",
          technique: "<strong>Listen first,</strong> then respond.",
          example: ""
        },
        "Sarcasm": {
          title: "Keep It Real 🎯",
          icon: "",
          description: "Say what you mean, mean what you say.",
          technique: "<strong>Be direct:</strong> Drop the sarcasm.",
          example: ""
        },
        "Judgmental": {
          title: "Stay Curious 🤔",
          icon: "",
          description: "Ask questions instead of judging.",
          technique: "<strong>Try:</strong> 'Tell me more about that.'",
          example: ""
        },
        "Agitated": {
          title: "Calm Down 🧘",
          icon: "",
          description: "Don't reply when you're angry.",
          technique: "<strong>Step away,</strong> come back later.",
          example: ""
        },
        "Neurotic": {
          title: "Relax ✨",
          icon: "",
          description: "You've got this! Take it easy.",
          technique: "<strong>Breathe</strong> and ground yourself.",
          example: ""
        },
        "Ego-centric": {
          title: "See Their Side ðŸ‘€",
          icon: "",
          description: "It's not always about you!",
          technique: "<strong>Try:</strong> Put yourself in their shoes.",
          example: ""
        },
        "Ignorant": {
          title: "Admit You Don't Know 🤷",
          icon: "",
          description: "It's cool to ask for help!",
          technique: "<strong>Say:</strong> 'Can you help me understand?'",
          example: ""
        }
      };
      
      return strategies[attribute] || null;
    }
    
    function generateStrategiesHTML(analysis) {
      if (!analysis.needsWork) {
        return `
          <div class="insight-box" style="text-align: center;">
            <div class="emoji-big">🌟</div>
            <div class="insight-title" style="justify-content: center;">Excellent Communication</div>
            <div class="insight-text">
              You consistently chose constructive, respectful responses that built understanding. Your communication style demonstrates emotional intelligence and creates positive interactions. Keep modeling this behavior in your community.
            </div>
          </div>`;
      }
      
      let html = '';
      html += '<div style="display: grid; gap: 12px;">';
      
      analysis.topNegative.forEach((attr, index) => {
        const strategy = getStrategyForAttribute(attr);
        if (strategy) {
          html += `
            <div style="background: rgba(0,0,0,.02); border: 1px solid rgba(0,0,0,.05); border-radius: 10px; padding: 14px; transition: all 0.2s ease;">
              <div style="font-size: 12px; font-weight: 700; color: var(--muted); margin-bottom: 8px;">Tip #${index + 1}</div>
              <div style="font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 10px;">${strategy.title}</div>
              <div style="font-size: 12px; color: var(--text); line-height: 1.5; margin-bottom: 10px;">${strategy.description}</div>
              <div style="background: rgba(255,215,0,0.08); border-left: 3px solid var(--accent); padding: 10px 12px; border-radius: 6px; font-size: 12px; color: var(--text); line-height: 1.5;">
                <div style="font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 700; margin-bottom: 4px;">How to:</div>
                ${strategy.technique}
              </div>
            </div>`;
        }
      });
      
      html += '</div>';
      return html;
    }
    
    function generateInsightsHTML(analysis, totalLikes, maxPossibleLikes) {
      let insights = '';
      
      // Helper function to convert attribute names to proper adjectives
      function toAdjective(attr) {
        const conversions = {
          'Sarcasm': 'sarcastic',
          'Polite': 'polite',
          'Funny': 'funny',
          'Empathetic': 'empathetic',
          'Encouraging': 'encouraging',
          'Ignorant': 'ignorant',
          'Ego-centric': 'self-centered',
          'Neurotic': 'anxious',
          'Agitated': 'agitated',
          'Aggressive': 'aggressive',
          'Rude': 'rude',
          'Disrespectful': 'disrespectful',
          'Judgmental': 'judgmental'
        };
        return conversions[attr] || attr.toLowerCase();
      }
      
      // Combine strengths and growth areas into one section
      if (analysis.topStrengths.length > 0 || analysis.topNegative.length > 0) {
        let strengthsText = '';
        let negativeText = '';
        
        if (analysis.topStrengths.length > 0) {
          const strengthsList = analysis.topStrengths.map(s => toAdjective(s)).join(', ');
          const verb = analysis.topStrengths.length === 1 ? 'creates' : 'create';
          strengthsText = `Your comments were ${strengthsList}. These qualities ${verb} positive interactions and build trust. `;
        }
        
        if (analysis.topNegative.length > 0) {
          const negativesList = analysis.topNegative.map(s => toAdjective(s)).join(', ');
          const verb = analysis.topNegative.length === 1 ? 'was' : 'were';
          negativeText = `Some of your comments ${verb} ${negativesList}. `;
        }
        
        insights += `
          <div class="insight-box">
            <div class="insight-title">
              <span>Your Online Reputation</span>
            </div>
            <div class="insight-text" style="font-size: 14px; line-height: 1.7;">
              ${strengthsText}${negativeText}
            </div>
          </div>`;
      }
      
      return insights;
    }
    
 function getKindnessMessage(score) {
  if (score >= 90) return "Empathy Master 🌟 — You lift every chat you enter!";
  if (score >= 75) return "Positive Vibes Pro ✨ — Your words make a real impact.";
  if (score >= 60) return "Kind Communicator ðŸ’¬ — Keep spreading good energy.";
  if (score >= 40) return "On the Rise 🚀 — You’re learning the power of kind words.";
  if (score >= 20) return "Starter Level 🌱 — Small changes can make big waves.";
  return "Time to Reflect 🔍 — Every message is a chance to do better.";
}

    function finishGame() {
      // End the game early and show results
      renderResultsPage();
    }

    function renderResultsPage(){
      const { rows, counts, totalTagged, negativeRows, totalLikes, maxPossibleLikes } = computePlayerMetrics();
      const analysis = generateBehavioralAnalysis(counts, rows, negativeRows);
      
      // Store these for the detailed page
      window.resultsData = { rows, counts, totalTagged, negativeRows, totalLikes, maxPossibleLikes, analysis };
      
      // Disconnect observer to prevent auto-scrolling on results page
      if (stageObserver) {
        stageObserver.disconnect();
        stageObserver = null;
      }
      
      // Stop video and hide video player
      if (captionInterval) {
        clearInterval(captionInterval);
        captionInterval = null;
      }
      isPlaying = false;
      
      const videoPlayer = document.getElementById('videoPlayer');
      if (videoPlayer) {
        videoPlayer.style.display = 'none';
        videoPlayer.classList.remove('video-playing');
      }

      // Show animated score page
      stage.innerHTML = `
        <div class="score-reveal fade-in">
          <div class="score-number" id="animatedScore">0</div>
          <div class="score-label">Your Score</div>
          <div class="score-sublabel">out of ${maxPossibleLikes} possible likes</div>
          <button class="cta next-btn" onclick="showDetailedResults()">Next</button>
        </div>`;
      
      // Animate the score counting up
      setTimeout(() => {
        animateScore(totalLikes);
      }, 100);
      
      stage.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function animateScore(targetScore) {
      const scoreEl = document.getElementById('animatedScore');
      if (!scoreEl) return;
      
      let currentScore = 0;
      const duration = 1500; // 1.5 seconds
      const increment = targetScore / (duration / 16); // 60fps
      
      const timer = setInterval(() => {
        currentScore += increment;
        if (currentScore >= targetScore) {
          currentScore = targetScore;
          clearInterval(timer);
        }
        scoreEl.textContent = Math.floor(currentScore);
      }, 16);
    }

    window.resultsPage = 1;
    
    function showDetailedResults(){
      const { rows, counts, totalTagged, negativeRows, totalLikes, maxPossibleLikes, analysis } = window.resultsData;
      window.resultsPage = 1;
      showResultsPage(1, { rows, counts, totalTagged, negativeRows, totalLikes, maxPossibleLikes, analysis });
    }
    
    function showResultsPage(pageNum, data){
      const { rows, counts, totalTagged, negativeRows, totalLikes, maxPossibleLikes, analysis } = data;
      window.resultsPage = pageNum;
      
      // Analytics: Track game completion on first results page
      if(pageNum === 1) {
        trackGameCompleted(Math.round((Date.now() - window.gameStartTime) / 1000));
        // Send complete data to Google Sheets
        sendGameDataToSheets(data);
      }
      
      if(pageNum === 1){
        // Page 1: Communication Profile + Online Reputation
        stage.innerHTML = `
          <div class="fade-in" style="display:grid; gap:16px;">
            <div class="tcard">
              <div class="name" style="font-size: 16px;">Your Communication Profile</div>
              <div class="k">Hover or tap each attribute to see its definition</div>
              <div id="profileMatrix" class="matrix-container"></div>
            </div>
            ${generateInsightsHTML(analysis, totalLikes, maxPossibleLikes)}
            <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top: 8px;">
              <button class="cta" onclick="showResultsPage(2, window.resultsData)">Next</button>
            </div>
            <div class="play-count-display">${getPlayCount()} people have played this game</div>
          </div>`;
        
        const profileMatrix = document.getElementById('profileMatrix');
        const maxCount = Math.max(...ATTRIBUTE_SET.map(a => counts[a] || 0), 1);
        const presentAttrs = ATTRIBUTE_SET.filter(attr => (counts[attr] || 0) > 0);
        presentAttrs.sort((a, b) => (counts[b] || 0) - (counts[a] || 0));
        
        let matrixHTML = '<div class="profile-matrix">';
        presentAttrs.forEach(attr => {
          const count = counts[attr] || 0;
          const definition = ATTRIBUTE_DEFINITIONS[attr] || '';
          matrixHTML += `
            <div class="profile-cell" 
                 onmouseenter="showProfileTooltip(event, '${attr.replace(/'/g, "\\'")}', '${definition.replace(/'/g, "\\'")}')" 
                 onmouseleave="hideTooltip()" 
                 ontouchstart="showProfileTooltip(event, '${attr.replace(/'/g, "\\'")}', '${definition.replace(/'/g, "\\'")}')"
                 ontouchend="hideTooltip()"
                 style="opacity: ${0.6 + (count / (maxCount + 1)) * 0.4}; border-left: 4px solid var(--accent);">
              <div class="cell-count">${count}</div>
              <div class="cell-name">${attr}</div>
            </div>`;
        });
        matrixHTML += '</div>';
        if(presentAttrs.length === 0) {
          matrixHTML = '<div style="text-align: center; color: var(--muted); padding: 24px; font-size: 13px;">No attributes recorded yet.</div>';
        }
        profileMatrix.innerHTML = matrixHTML;
      }
      else if(pageNum === 2){
        // Page 2: Response History
        stage.innerHTML = `
          <div class="fade-in" style="display:grid; gap:16px;">
            <div class="tcard">
              <div class="name" style="font-size: 16px;">Your Response History</div>
              <div id="logBody" style="display: grid; gap: 12px; margin-top: 12px;"></div>
            </div>
            <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top: 8px;">
              <button class="reset" onclick="showResultsPage(1, window.resultsData)">Back</button>
              <button class="cta" onclick="showResultsPage(3, window.resultsData)">Next</button>
            </div>
          </div>`;
        
        const logBody = document.getElementById('logBody');
        logBody.innerHTML = rows.map((r,i)=>`
          <div style="background: rgba(0,0,0,.02); border: 1px solid rgba(0,0,0,.05); border-radius: 10px; padding: 14px; transition: all 0.2s ease; cursor: pointer;" 
               onmouseenter="this.style.borderColor='var(--accent)'; this.style.boxShadow='0 2px 8px rgba(255,215,0,0.2)'; this.style.background='rgba(0,0,0,.04)';"
               onmouseleave="this.style.borderColor='rgba(0,0,0,.05)'; this.style.boxShadow='none'; this.style.background='rgba(0,0,0,.02)';">
            <div style="font-size: 12px; font-weight: 700; color: var(--muted); margin-bottom: 6px;">Response #${i+1}</div>
            <div style="font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 12px; line-height: 1.4;">${r.comment}</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 8px;">
              <div>
                <div style="font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 700; margin-bottom: 3px;">Likes</div>
                <div style="font-size: 14px; font-weight: 700; color: ${r.likes === 10 ? 'var(--good)' : r.likes === 3 ? '#ff9800' : 'var(--bad)'};">${r.likes == 0 ? '👎 ' + (Math.floor(Math.random() * 9) + 1) : r.likes}</div>
              </div>
              <div>
                <div style="font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 700; margin-bottom: 3px;">Style</div>
                <div style="font-size: 12px; color: var(--text); font-weight: 600;">${(r.mappedAttrs||[]).join(', ') || '””'}</div>
              </div>
            </div>
            <div>
              <div style="font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 700; margin-bottom: 3px;">Impact</div>
              <div style="font-size: 12px; color: var(--text); font-weight: 600;">${r.feeling || '””'}</div>
            </div>
          </div>
        `).join('');
      }
      else if(pageNum === 3){
        // Page 3: Tools for Better Communication
        stage.innerHTML = `
          <div class="fade-in" style="display:grid; gap:16px;">
            <div class="tcard">
              <div class="name" style="font-size: 20px; margin-bottom: 8px;">
                Tools for Better Communication
              </div>
              <div class="k" style="margin-bottom: 16px; font-size: 14px;">Quick tips to level up your chat game! ðŸ’¬</div>
              ${generateStrategiesHTML(analysis)}
              

            </div>
            <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top: 8px;">
              <button class="reset" onclick="showResultsPage(2, window.resultsData)">Back</button>
              <button class="cta" onclick="showResultsPage(4, window.resultsData)">Next</button>
            </div>
          </div>`;
      }
      else if(pageNum === 4){
        // Page 4: Final Actions
        stage.innerHTML = `
          <div class="fade-in" style="display:grid; gap:16px;">
            <div class="tcard">
              <div class="name" style="font-size: 18px;">Great Job!</div>
              <div class="k"> Check how freindly is your community or play again.</div>
            </div>
            <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top: 8px;">
              <button class="reset" onclick="showResultsPage(3, window.resultsData)">Back</button>
              <button class="cta" onclick="trackLinkClick('Check Community'); window.open('https://www.felixagaming.com/report/p/felixa-online-safety-report-for-parents-ptt5b','_blank')">Check Your Community</button>
              <button class="reset" onclick="trackLinkClick('Play Again'); restart()">Play Again</button>
            </div>
          </div>`;
      }
      
      stage.scrollTo({ top: 0, behavior: 'smooth' });
    }

    let stageObserver = null;

    function safeStart(){
      try {
        if(!document.getElementById('stage')){
          document.addEventListener('DOMContentLoaded', safeStart, { once: true });
          return;
        }
        stage = document.getElementById('stage');
        scenarioIndex = 0; 
        exchangeIndex = 0; 
        stage.innerHTML = '';
        
        // Disconnect old observer if exists
        if (stageObserver) {
          stageObserver.disconnect();
        }
        
        // Add mutation observer to auto-scroll when content changes
        stageObserver = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.addedNodes.length > 0) {
              const lastAdded = mutation.addedNodes[mutation.addedNodes.length - 1];
              if (lastAdded.nodeType === Node.ELEMENT_NODE) {
                scrollToElement(lastAdded);
              }
            }
          });
        });
        
        stageObserver.observe(stage, {
          childList: true,
          subtree: false,
          attributes: false
        });
        
        // Don't start scenarios automatically - video will trigger it
        updateProgress();
      } catch(err){
        console.error('Startup error:', err);
        if(stage){
          stage.innerHTML = `
            <div class="tcard fade-in">
              <div class="name">Could not start the game</div>
              <div class="k">${(err && err.message) ? err.message : 'Unknown error'}</div>
              <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
                <button class="reset" onclick="safeStart()">Try Again</button>
                <button class="reset" onclick="restart()">Reset</button>
              </div>
            </div>`;
        }
      }
    }

    function showProfileTooltip(event, attr, definition) {
      hideTooltip();
      
      // Prevent default touch behavior
      if (event.type === 'touchstart') {
        event.preventDefault();
      }
      
      const tooltip = document.createElement('div');
      tooltip.id = 'activeTooltip';
      tooltip.className = 'tooltip';
      tooltip.innerHTML = `
        <div class="tooltip-label">${attr}</div>
        <div class="tooltip-def">${definition}</div>`;
      document.body.appendChild(tooltip);
      
      const rect = event.target.getBoundingClientRect();
      let left = rect.left + rect.width / 2 - tooltip.offsetWidth / 2;
      let top = rect.top - tooltip.offsetHeight - 10;
      
      // Clamp to viewport
      if(left < 10) left = 10;
      if(left + tooltip.offsetWidth > window.innerWidth - 10) left = window.innerWidth - tooltip.offsetWidth - 10;
      if(top < 10) top = rect.bottom + 10;
      
      tooltip.style.left = left + 'px';
      tooltip.style.top = top + 'px';
      
      // Auto-hide tooltip on mobile after 3 seconds
      if (event.type === 'touchstart') {
        setTimeout(hideTooltip, 3000);
      }
    }

    function showTooltip(event, attr, definition) {
      showProfileTooltip(event, attr, definition);
    }

    function hideTooltip() {
      const existing = document.getElementById('activeTooltip');
      if(existing) existing.remove();
    }
    
    // Close tooltip when clicking/touching outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.profile-cell') && !e.target.closest('.tooltip')) {
        hideTooltip();
      }
    });
    
    document.addEventListener('touchstart', function(e) {
      if (!e.target.closest('.profile-cell') && !e.target.closest('.tooltip')) {
        hideTooltip();
      }
    });

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      safeStart();
      initPlayCounter();
    } else {
      document.addEventListener('DOMContentLoaded', function() {
        safeStart();
        initPlayCounter();
      }, { once: true });
    }

  </script>
</body>
</html>
